package db

import (
	"database/sql"
	"expdb/models"
	"fmt"

	_ "github.com/lib/pq"
)

var expDatabaseInfo = PostgresDB{
	Host:     "localhost",
	Port:     5432,
	Name:     "exploitDB",
	Username: "postgres",
	Password: "admin",
	Ssl:      "disable",
}

func InitExploitDB() (*sql.DB, error) {
	expDB, err := expDatabaseInfo.init()
	if err != nil {
		return nil, err
	}
	err = createExploitTable(expDB)
	if err != nil {
		return nil, err
	}
	return expDB, nil
}

func InsertExploit(db *sql.DB, exploit models.Exploit) error {
	values := fmt.Sprintf("%s, %s, %s, %s", exploit.Date, exploit.Title, exploit.Type, exploit.Platform)
	_, err := insertRow(db, "exploits", values)
	if err != nil {
		return err
	}
	return nil
}

func createExploitTable(db *sql.DB) error {
	statement := `CREATE TABLE IF NOT EXISTS exploits (
	date DATE NOT NULL DEFAULT CURRENT_DATE,
	title TEXT,
	type TEXT,
	platform TEXT
	)`
	_, err := db.Exec(statement)
	return err
}

func ResetExploitDB() error {
	err := expDatabaseInfo.reset("exploits")
	return err
}
